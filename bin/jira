#!/usr/bin/env php
<?php

error_reporting(E_ALL);
ini_set('display_errors', 1);

require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;
use Technodelight\Jira\Console\Application\Bootstrap;

try {;
    $version = trim(file_get_contents(__DIR__ . DIRECTORY_SEPARATOR . '.version'));
    $boot = new Bootstrap();
    $input = new ArgvInput();
    $output = new ConsoleOutput();
    $app = $boot->boot(
        $version,
        [
            join(DIRECTORY_SEPARATOR, ['src', 'Technodelight', 'Jira', 'Resources', 'configs'])
        ],
        $input
    );
    $app->run($input, $output);
} catch (Technodelight\Jira\Configuration\Symfony\MissingConfigurationException $exc) {
    // allow init method when configuration is missing
    if ($input->getFirstArgument() == 'init') {
        $app->run($input, $output);
    } else {
        $output = new ConsoleOutput;
        $output->writeLn('No configuration file found. Please run `init` first.');
    }
} catch (Exception $exc) {
    $output = new ConsoleOutput;
    $output->setVerbosity(ConsoleOutput::VERBOSITY_VERBOSE);
    $errorApp = isset($app) ? $app : new \Symfony\Component\Console\Application;
    $errorApp->renderException($exc, $output);
    if (is_numeric($exc->getCode())) {
        exit($exc->getCode());
    }
    exit(128);
}
